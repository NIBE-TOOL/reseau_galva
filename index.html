<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Note de calcul réseau Galva pour NIBE S735</title>
<style>
  :root{ --line:#e3e7ee; --text:#1f2630; --muted:#5b6676; --accent:#1b6bd6;
         --fs-body:14px; --fs-small:12px; --fs-justif:11px; }
  *,*::before,*::after{box-sizing:border-box}
  html,body{margin:0;background:#fff;color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1100px;margin:22px auto;padding:18px}
  h1{font-size:24px;text-transform:uppercase;text-align:center;margin-bottom:20px}

  form{border:1px solid var(--line);border-radius:12px;padding:16px;background:#fff}
  fieldset{border:1px solid var(--line);border-radius:10px;margin:12px 0;padding:12px}
  legend{font-weight:700}
  .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .field{display:flex;flex-direction:column}
  label{font-weight:600;font-size:13px;margin-bottom:6px}
  input,select{width:100%;padding:8px;border:1px solid var(--line);border-radius:8px;font-size:14px}
  .hint{font-size:11px;color:var(--muted);margin-top:4px}
  .piece{border:1px dashed var(--line);border-radius:10px;padding:10px;margin-top:10px}
  .row{display:flex;gap:8px;align-items:center}
  .actions{display:flex;gap:10px;margin-top:12px}
  button{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
  button.secondary{background:#eef3fe;color:#0d3691}
  .ghost{background:#f7f9ff;color:#0d3691;border:1px dashed #c7d7ff}

  /* Rapport */
  #rapport{display:none;margin-top:18px;border:1px solid var(--line);border-radius:12px;padding:18px;background:#fff}
  .header{display:grid;grid-template-columns:1fr 1fr;gap:10px;color:var(--muted);font-size:var(--fs-small)}
  .header b{color:var(--text)}
  .header-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .rule{height:1px;background:var(--line);margin:10px 0 14px}

  table{width:100%;border-collapse:collapse;font-size:var(--fs-body);margin-bottom:14px;table-layout:fixed}
  th,td{border:1px solid var(--line);padding:10px;vertical-align:top;text-align:center}
  th{background:#f6f8fb}
  td.left{text-align:left}
  .calc{font-size:var(--fs-justif);color:var(--muted);text-align:left;line-height:1.25}
  .sum{font-weight:700;background:#fbfdff}

  /* Entrées d’air compact */
  .airTable{width:70%; margin:4px 0 0 auto; font-size:12px}
  .airTable th,.airTable td{padding:6px}
  .airTable th{background:#f9fbff}

  /* Compactage auto */
  #rapport.tight table{font-size:13px}
  #rapport.tight th,#rapport.tight td{padding:8px}
  #rapport.tight .calc{font-size:10.5px}
  #rapport.ultra table{font-size:12px}
  #rapport.ultra th,#rapport.ultra td{padding:6px}
  #rapport.ultra .calc{font-size:10px}
  #rapport.tight .header{font-size:11px}
  #rapport.ultra .header{font-size:10px}
  #rapport.tight .header-bar{margin-bottom:6px}
  #rapport.ultra .header-bar{margin-bottom:4px}
  #rapport.tight .rule{margin:8px 0 10px}
  #rapport.ultra .rule{margin:6px 0 8px}

  /* Impression : uniquement le rapport */
  @media print{
    @page{ size: A4 landscape; margin: 8mm }
    .no-print{ display:none !important }
    .wrap{max-width:none;margin:0;padding:0}
    #rapport{ display:block !important; border:0; border-radius:0; padding:6mm 6mm 5mm 6mm; margin:0 }
    #rapport .printBtn{ display:none !important }
    table{ page-break-inside:auto }
    tr,td,th{ page-break-inside:avoid; page-break-after:auto }
  }
</style>
</head>
<body>
<div class="wrap">

  <h1>Note de calcul réseau Galva pour NIBE S735</h1>

  <!-- === FORMULAIRE === -->
  <form id="form" class="no-print">
    <fieldset>
      <legend>Données administratives</legend>
      <div class="grid-3">
        <div class="field"><label>Type de bâtiment</label>
          <select id="bat_type">
            <option value="maison">Maison individuelle</option>
            <option value="collectif">Immeuble collectif</option>
          </select>
        </div>
        <div class="field"><label>Installateur (Nom / Société)</label><input id="inst_nom" required></div>
        <div class="field"><label>N° SIRET</label><input id="inst_siret"></div>

        <div class="field"><label>Email installateur</label><input id="inst_email" type="email" required></div>
        <div class="field"><label>Date de l'étude</label><input id="date_etude" type="date"></div>
        <div class="field"><label>Nom et prénom (qui a réalisé cette étude)</label><input id="audit_fullname" required placeholder="Ex : Marie Martin"></div>

        <div class="field"><label>Email client final</label><input id="client_email" type="email"></div>
        <div class="field"><label>Marque bouches d’extraction</label><input id="brand_bouches" value="NIBE"></div>
        <div class="field"><label>Marque entrées d’air</label><input id="brand_entrees" value="NIBE"></div>

        <div class="field" style="grid-column:1/-1"><label>Adresse chantier</label><input id="client_adresse"></div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Type de logement</legend>
      <div class="field" style="max-width:340px">
        <label>Nombre de chambres</label>
        <select id="nb_chambres">
          <option value="1">1 chambre (T2)</option>
          <option value="2">2 chambres (T3)</option>
          <option value="3" selected>3 chambres (T4)</option>
          <option value="4">4 chambres (T5)</option>
          <option value="5">5 chambres (T6)</option>
          <option value="6">6 chambres (T7)</option>
          <option value="7">7 chambres et + (T7+)</option>
        </select>
      </div>
      <div class="field" style="margin-top:12px;max-width:650px">
        <label>Pièces principales supplémentaires</label>
        <div id="pp_list"></div>
        <div class="row" style="margin-top:6px">
          <input id="pp_input" placeholder="ex : Bureau RDC" style="flex:1">
          <button type="button" id="pp_add" class="ghost">+ Ajouter une pièce principale</button>
        </div>
        <div class="hint">(bureau, salle de jeux, bibliothèque…)</div>
      </div>
    </fieldset>

    <!-- Conduit principal — Aspiration PAC -->
    <fieldset>
      <legend>Conduit principal — Aspiration PAC</legend>
      <div class="grid-4">
        <div class="field"><label>Diamètre (mm)</label>
          <select id="main_diam"><option>125</option><option>160</option></select></div>
        <div class="field"><label>Longueur droite (m)</label><input id="main_len" type="number" value="6" step="0.1" min="0"></div>
        <div class="field"><label>Coudes 30°</label><input id="main_c30" type="number" value="0" min="0"></div>
        <div class="field"><label>Coudes 45°</label><input id="main_c45" type="number" value="0" min="0"></div>
        <div class="field"><label>Coudes 90°</label><input id="main_c90" type="number" value="2" min="0"></div>
      </div>
      <div class="hint">Les T (piquages) sont ajoutés automatiquement : 1 T par pièce d’eau.</div>
    </fieldset>

    <!-- Pièces d’eau -->
    <fieldset>
      <legend>Pièces d’eau</legend>

      <div class="piece" id="piece_cuisine">
        <strong>CUISINE</strong>
        <div class="grid-4" style="margin-top:8px">
          <div class="field"><label>Débit mini (m³/h)</label><input id="cui_q_min" type="number" min="0" step="1"></div>
          <div class="field"><label>Grand débit cuisine (m³/h)</label><input id="cui_q_max" type="number" min="0" step="1"></div>
          <div class="field"><label>Diamètre (mm)</label>
            <select id="cui_diam"><option>125</option><option>160</option><option>80</option></select>
          </div>
          <div class="field"><label>Longueur droite (m)</label><input id="cui_len" type="number" value="6" min="0" step="0.1"></div>
          <div class="field"><label>Coudes 30°</label><input id="cui_c30" type="number" value="0" min="0"></div>
          <div class="field"><label>Coudes 45°</label><input id="cui_c45" type="number" value="0" min="0"></div>
          <div class="field"><label>Coudes 90°</label><input id="cui_c90" type="number" value="2" min="0"></div>
        </div>
        <div class="hint" id="cui_warn" style="display:none;color:#b40000;font-weight:600">vitesse d’air trop élevée (Ø80 avec ≥45 m³/h)</div>
      </div>

      <div id="pieces_autres"></div>
      <div class="actions" style="margin-top:10px">
        <button type="button" class="secondary" id="addPieceBtn">+ Ajouter une pièce d'eau</button>
      </div>
    </fieldset>

    <!-- Conduit de rejet & sortie -->
    <fieldset>
      <legend>Conduit de rejet & sortie</legend>
      <div class="grid-4">
        <div class="field"><label>Diamètre (mm)</label><select id="rej_diam"><option>125</option><option>160</option></select></div>
        <div class="field"><label>Longueur droite (m)</label><input id="rej_len" type="number" value="6" step="0.1" min="0"></div>
        <div class="field"><label>Coudes 30°</label><input id="rej_c30" type="number" value="0" min="0"></div>
        <div class="field"><label>Coudes 45°</label><input id="rej_c45" type="number" value="0" min="0"></div>
        <div class="field"><label>Coudes 90°</label><input id="rej_c90" type="number" value="1" min="0"></div>
      </div>
      <div class="grid-3" style="margin-top:10px">
        <div class="field" style="grid-column:1/-1"><label>Type de sortie</label>
          <select id="rej_sortie">
            <option value="facade">Façade</option>
            <option value="toiture">Toiture</option>
          </select>
        </div>
      </div>
      <div class="hint">Sortie façade = 11 Pa ; Sortie toiture = 15 Pa.</div>
    </fieldset>

    <div class="actions">
      <button type="button" id="genBtn">Générer le rapport</button>
    </div>
  </form>

  <!-- === RAPPORT FINAL === -->
  <div id="rapport">
    <div class="header-bar">
      <button type="button" class="secondary printBtn" id="printBtn">Imprimer le rapport</button>
    </div>
    <div class="header" id="r-head-1"></div>
    <div class="header" id="r-head-2" style="margin-top:6px"></div>
    <div class="rule"></div>

    <table id="tabMain">
      <thead>
        <tr>
          <th class="left">Élément</th>
          <th>Débit mini<br>(m³/h)</th>
          <th>Grand débit cuisine<br>(m³/h)</th>
          <th>Pertes de charge<br>(Pa)</th>
          <th class="left">Détails calcul</th>
        </tr>
      </thead>
      <tbody id="r-rows"></tbody>
    </table>

    <table class="airTable" id="tabAir">
      <thead>
        <tr>
          <th class="left">Entrées d’air</th>
          <th>Débit (m³/h)</th>
        </tr>
      </thead>
      <tbody id="r-air"></tbody>
    </table>
  </div>
</div>

<script>
/* ===== Pertes GALVA ===== */
const LIN = { 80:1.8, 125:3.1, 160:1.3 }; // Pa/m
const C30 = 1.2, C45 = 1.6, C90 = 2.8;    // Pa/coude
const T90 = 13.4;                         // Pa/ té (principal)
const SORTIE = { facade:11, toiture:15 }; // Pa fixes

/* ===== Utils ===== */
const $ = sel => document.querySelector(sel);
function n(x){ return Number(x||0); }
function cuisineDefaults(nb){
  nb=Number(nb);
  if (nb<=1) return {mini:30, grand:90};
  if (nb===2) return {mini:45, grand:105};
  if (nb===3) return {mini:45, grand:120};
  return {mini:45, grand:135};
}
function titreLogement(nb){
  if (nb<=1) return 'T2';
  if (nb===2) return 'T3';
  if (nb===3) return 'T4';
  if (nb===4) return 'T5';
  if (nb===5) return 'T6';
  return (nb>=7)?'T7+':'T7';
}
function debitFuite(type, nbCh){
  const T = titreLogement(nbCh);
  const valMaison = {T2:45,T3:60,T4:75,T5:90,T6:105,'T7':120,'T7+':120};
  const valColl   = {T2:30,T3:40,T4:50,T5:60,T6:70,'T7':80,'T7+':80};
  return (type==='maison' ? (valMaison[T]??0) : (valColl[T]??0));
}

/* ===== Pièces principales supplémentaires ===== */
const ppListEl = $('#pp_list'), ppInput = $('#pp_input');
$('#pp_add').addEventListener('click', ()=>{
  const name = (ppInput.value||'').trim(); if(!name) return;
  const row = document.createElement('div');
  row.className='row'; row.style.marginTop='6px';
  row.innerHTML = `<input class="pp_name" value="${name.replace(/"/g,'&quot;')}" style="flex:1">
                   <button type="button" class="ghost pp_remove">Supprimer</button>`;
  row.querySelector('.pp_remove').addEventListener('click', ()=> row.remove());
  ppListEl.appendChild(row);
  ppInput.value='';
});
function getPPNames(){
  return Array.from(document.querySelectorAll('#pp_list .pp_name')).map(i=>i.value.trim()).filter(Boolean);
}

/* ===== Entrées d’air ===== */
function baseEntreesAir(nbCh, ppNames){
  const list=[];
  const qStd = (nbCh>=5) ? 22 : 30; // T6/T7+ => 22 ; sinon 30
  for(let i=1;i<=nbCh;i++) list.push({lib:`Chambre ${i}`, q:qStd, type:'ch'});
  ppNames.forEach(name=> list.push({lib:name, q:qStd, type:'pp'}));
  list.push({lib:'Séjour', q:(nbCh<=2?60:45), type:'sej'});
  return list;
}
function ajusterEntreesAir(liste, besoinMini){
  let note='', modif=false;
  const sum = () => liste.reduce((s,a)=>s+a.q,0);
  if (sum() < besoinMini){
    // 1) chambres/PP 22 -> 30
    let changed=false;
    liste.forEach(a=>{
      if ((a.type==='ch' || a.type==='pp') && a.q===22){ a.q=30; changed=true; }
    });
    if (changed){ note += 'Chambres/PP ajustées à 30 m³/h. '; modif=true; }
  }
  if (sum() < besoinMini){
    // 2) séjour -> 90
    const sej = liste.find(a=>a.type==='sej');
    if (sej && sej.q<90){ sej.q=90; note += 'Séjour ajusté à 2×45=90 m³/h. '; modif=true; }
  }
  const insuff = sum() < besoinMini;
  return {liste, note: note.trim(), insuffisant: insuff, modif};
}

/* ===== UI Pièces d’eau (autres) ===== */
$('#addPieceBtn').addEventListener('click', ()=>{
  const box=document.createElement('div'); box.className='piece';
  box.innerHTML=`
    <strong>Pièce d'eau</strong>
    <div class="grid-4" style="margin-top:8px">
      <div class="field"><label>Nom</label><input name="nom" value="Salle de bain"></div>
      <div class="field"><label>Débit (m³/h)</label><input name="q" type="number" value="30" min="0" step="1"></div>
      <div class="field"><label>Diamètre (mm)</label>
        <select name="d"><option>125</option><option>160</option><option>80</option></select>
      </div>
      <div class="field"><label>Longueur droite (m)</label><input name="len" type="number" value="5" min="0" step="0.1"></div>
      <div class="field"><label>Coudes 30°</label><input name="c30" type="number" value="0" min="0"></div>
      <div class="field"><label>Coudes 45°</label><input name="c45" type="number" value="0" min="0"></div>
      <div class="field"><label>Coudes 90°</label><input name="c90" type="number" value="1" min="0"></div>
    </div>
    <div class="hint warn" style="display:none;color:#b40000;font-weight:600">vitesse d’air trop élevée (Ø80 avec ≥45 m³/h)</div>
  `;
  document.getElementById('pieces_autres').appendChild(box);
});

/* ===== Init défauts ===== */
document.getElementById('date_etude').valueAsDate = new Date();
const elNbCh=document.getElementById('nb_chambres');
function applyCuisineDefaults(){
  const d=cuisineDefaults(elNbCh.value);
  document.getElementById('cui_q_min').value=d.mini;
  document.getElementById('cui_q_max').value=d.grand;
}
elNbCh.addEventListener('change', applyCuisineDefaults);
applyCuisineDefaults();

/* ===== Alerte vitesse d'air (Ø80 avec ≥45 m³/h) ===== */
function checkVelocityWarnings(){
  const cd = Number(document.getElementById('cui_diam').value);
  const cq = Number(document.getElementById('cui_q_min').value||0);
  const warnCui = document.getElementById('cui_warn');
  warnCui.style.display = (cd===80 && cq>=45) ? 'block' : 'none';

  document.querySelectorAll('#pieces_autres .piece').forEach(piece=>{
    const q = Number(piece.querySelector('input[name="q"]').value||0);
    const d = Number(piece.querySelector('select[name="d"]').value);
    const w = piece.querySelector('.warn');
    if (d===80 && q>=45) w.style.display='block'; else w.style.display='none';
  });
}
document.getElementById('cui_diam').addEventListener('change', checkVelocityWarnings);
document.getElementById('cui_q_min').addEventListener('input', checkVelocityWarnings);

/* ===== Impression ===== */
document.getElementById('printBtn').addEventListener('click', ()=> window.print() );

/* ===== Génération du rapport ===== */
document.getElementById('genBtn').addEventListener('click', ()=>{
  // Admin
  const batType = $('#bat_type').value; // maison | collectif
  const inst =$('#inst_nom').value||'—';
  const siret=$('#inst_siret').value||'—';
  const mailI=$('#inst_email').value||'—';
  const date =$('#date_etude').value ? new Date($('#date_etude').value).toLocaleDateString('fr-FR') : new Date().toLocaleDateString('fr-FR');
  const audit=$('#audit_fullname').value||'—';
  const bB   =$('#brand_bouches').value||'—';
  const bE   =$('#brand_entrees').value||'—';
  const mailC=$('#client_email').value||'—';
  const addr =$('#client_adresse').value||'—';

  // Type logement
  const nbCh = Number($('#nb_chambres').value);
  const ppNames = getPPNames();

  // Conduit principal — aspiration
  const main_d =n($('#main_diam').value);
  const main_l =n($('#main_len').value);
  const main_c30=n($('#main_c30').value);
  const main_c45=n($('#main_c45').value);
  const main_c90=n($('#main_c90').value);

  // Cuisine
  const cui_q_min=n($('#cui_q_min').value);
  const cui_q_max=n($('#cui_q_max').value);
  const cui_d=n($('#cui_diam').value);
  const cui_len=n($('#cui_len').value);
  const cui_c30=n($('#cui_c30').value);
  const cui_c45=n($('#cui_c45').value);
  const cui_c90=n($('#cui_c90').value);

  // Autres pièces d’eau
  const autres=Array.from(document.querySelectorAll('#pieces_autres .piece')).map(node=>({
    nom: node.querySelector('input[name="nom"]').value||'Pièce d’eau',
    q:   n(node.querySelector('input[name="q"]').value),
    d:   n(node.querySelector('select[name="d"]').value),
    len: n(node.querySelector('input[name="len"]').value),
    c30: n(node.querySelector('input[name="c30"]').value),
    c45: n(node.querySelector('input[name="c45"]').value),
    c90: n(node.querySelector('input[name="c90"]').value),
  }));

  // Rejet & sortie
  const rej_d =n($('#rej_diam').value);
  const rej_l =n($('#rej_len').value);
  const rej_c30=n($('#rej_c30').value);
  const rej_c45=n($('#rej_c45').value);
  const rej_c90=n($('#rej_c90').value);
  const rej_sortie=$('#rej_sortie').value;

  /* === Débits totaux === */
  let sumQmini=cui_q_min, sumQgrand=cui_q_max;
  autres.forEach(p=>{ sumQmini+=p.q; sumQgrand+=p.q; });

  /* === Pertes pièces d’eau (GALVA) === */
  let rows=[], sumP=0;
  function pdcGalva(diam, len, c30, c45, c90){
    const per_m = LIN[diam] || 0;
    return per_m*len + C30*c30 + C45*c45 + C90*c90;
  }

  // Cuisine
  const pCui = pdcGalva(Number(cui_d), cui_len, cui_c30, cui_c45, cui_c90);
  rows.push({label:`Cuisine Ø${cui_d}`, qMin:cui_q_min, qGrand:cui_q_max, p:pCui,
    det:`Lin: ${(LIN[cui_d]||0).toFixed(2)} Pa/m × ${cui_len} m ; Coudes 30°:${cui_c30} ; 45°:${cui_c45} ; 90°:${cui_c90}`});
  sumP+=pCui;

  // Autres pièces
  autres.forEach(p=>{
    const pdc = pdcGalva(p.d, p.len, p.c30, p.c45, p.c90);
    rows.push({label:`${p.nom} Ø${p.d}`, qMin:p.q, qGrand:'—', p:pdc,
      det:`Lin: ${(LIN[p.d]||0).toFixed(2)} Pa/m × ${p.len} m ; Coudes 30°:${p.c30} ; 45°:${p.c45} ; 90°:${p.c90}`});
    sumP+=pdc;
  });

  /* === Conduit principal — aspiration (avec T = nb pièces) === */
  const nbPieces = 1 + autres.length; // 1 pour cuisine + autres
  const pMain = pdcGalva(main_d, main_l, main_c30, main_c45, main_c90) + nbPieces * T90;
  rows.push({label:`Conduit principal aspiration Ø${main_d}`, qMin:sumQmini, qGrand:sumQgrand, p:pMain,
    det:`Lin: ${(LIN[main_d]||0).toFixed(2)} Pa/m × ${main_l} m ; Coudes 30°:${main_c30} ; 45°:${main_c45} ; 90°:${main_c90} ; T x ${nbPieces} = ${(nbPieces*T90).toFixed(1)} Pa`});
  sumP+=pMain;

  /* === Conduit de rejet + sortie === */
  const pRej = pdcGalva(rej_d, rej_l, rej_c30, rej_c45, rej_c90) + (SORTIE[rej_sortie]||0);
  const sortieLabel = (rej_sortie==='facade'?'Façade 11 Pa':'Toiture 15 Pa');
  rows.push({label:`Conduit de rejet Ø${rej_d} + ${sortieLabel}`, qMin:sumQmini, qGrand:sumQgrand, p:pRej,
    det:`Lin: ${(LIN[rej_d]||0).toFixed(2)} Pa/m × ${rej_l} m ; Coudes 30°:${rej_c30} ; 45°:${rej_c45} ; 90°:${rej_c90} ; Sortie: ${(SORTIE[rej_sortie]||0).toFixed(1)} Pa`});
  sumP+=pRej;

  /* === ENTRÉES D’AIR : calcul + ajustements === */
  let airList = baseEntreesAir(nbCh, ppNames);
  const fuite = debitFuite(batType, nbCh);
  const besoinMini = sumQgrand - fuite; // seuil
  const aj = ajusterEntreesAir(airList, besoinMini);
  airList = aj.liste;
  const sumAir = airList.reduce((s,a)=>s+a.q,0);

  /* === En-têtes rapport === */
  $('#r-head-1').innerHTML =
    `<div><b>Installateur :</b> ${inst} (${siret}) — ${mailI}</div>
     <div><b>Étude réalisée par :</b> ${audit}</div>`;
  // Type de bâtiment déplacé à gauche SOUS le client
  $('#r-head-2').innerHTML =
    `<div><b>Client :</b> ${addr} — ${mailC}<br><b>Type de bâtiment :</b> ${batType==='maison'?'Maison individuelle':'Immeuble collectif'}</div>
     <div><b>Date :</b> ${date} — <b>Marques :</b> Bouches=${bB||'—'} ; Entrées d’air=${bE}</div>`;

  /* === Remplir tableau principal === */
  const tbody=document.getElementById('r-rows'); tbody.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="left">${r.label}</td>
      <td>${typeof r.qMin==='number'?r.qMin.toFixed(0):r.qMin}</td>
      <td>${typeof r.qGrand==='number'?r.qGrand.toFixed(0):r.qGrand}</td>
      <td>${r.p.toFixed(2)}</td>
      <td class="calc">${r.det}</td>`;
    tbody.appendChild(tr);
  });

  /* === Total (fin de tbody) === */
  const trTot = document.createElement('tr');
  trTot.className = 'sum';
  trTot.innerHTML = `
    <td class="left">TOTAL — Somme des débits / PDC</td>
    <td>${sumQmini.toFixed(0)}</td>
    <td>${sumQgrand.toFixed(0)}</td>
    <td>${sumP.toFixed(2)}</td>
    <td>${aj.modif ? `<span class="calc">Ajustements auto : ${aj.note}</span>` : ''}</td>`;
  tbody.appendChild(trTot);

  /* === Entrées d’air === */
  const airBody=document.getElementById('r-air'); 
  airBody.innerHTML='';
  airList.forEach(a=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="left">${a.lib}</td><td>${a.q}</td>`;
    airBody.appendChild(tr);
  });
  // Total
  const trAirTot=document.createElement('tr');
  trAirTot.className='sum';
  trAirTot.innerHTML=`<td class="left">Total entrées d’air</td><td>${sumAir.toFixed(0)}</td>`;
  airBody.appendChild(trAirTot);
  // Débit de fuite (nouvelle ligne sous le total)
  const trFuite=document.createElement('tr');
  trFuite.innerHTML=`<td class="left"><span class="calc"><b>Débit de fuite</b> (m³/h)</span></td><td>${fuite.toFixed(0)}</td>`;
  airBody.appendChild(trFuite);

  // Alerte si insuffisant malgré ajustements
  const oldWarn = document.getElementById('warn-air');
  if (oldWarn) oldWarn.remove();
  if (sumAir < besoinMini){
    const warn = document.createElement('div');
    warn.id = 'warn-air';
    warn.style.cssText = 'margin-top:6px;color:#b40000;font-weight:700';
    warn.textContent = '⚠️ Les entrées d’air restent insuffisantes (Grand débit cuisine − Débit de fuite). Augmentez manuellement.';
    document.getElementById('rapport').appendChild(warn);
  }

  /* === Compactage auto (pour tenir sur 1 page) === */
  const r = document.getElementById('rapport');
  r.classList.remove('tight','ultra');
  const linesMain = rows.length + 1; // + total
  const linesAir  = airList.length + 2; // + total + fuite
  const totalLines = linesMain + Math.ceil(linesAir*0.7);
  if (totalLines > 24 && totalLines <= 32) r.classList.add('tight');
  if (totalLines > 32) r.classList.add('ultra');

  /* === Afficher rapport === */
  r.style.display='block';
  r.scrollIntoView({behavior:'smooth',block:'start'});
});
</script>
</body>
</html>
